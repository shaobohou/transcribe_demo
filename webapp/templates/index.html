<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcribe Demo - Real-time Audio Transcription</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: #475569;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px var(--shadow);
            border: 1px solid var(--border);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .control-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        button {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--background);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border);
            animation: pulse 2s ease-in-out infinite;
        }

        .status-indicator.active {
            background: var(--success-color);
        }

        .status-indicator.error {
            background: var(--danger-color);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .transcript-container {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
            font-size: 0.95rem;
        }

        .transcript-container::-webkit-scrollbar {
            width: 8px;
        }

        .transcript-container::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 4px;
        }

        .transcript-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .transcript-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .transcript-chunk {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .transcript-chunk.partial {
            background: rgba(99, 102, 241, 0.1);
            font-style: italic;
            color: var(--text-secondary);
        }

        .transcript-chunk.final {
            color: var(--text-primary);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .advanced-options {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .advanced-toggle {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .advanced-toggle:hover {
            color: var(--primary-hover);
        }

        .advanced-content {
            display: none;
        }

        .advanced-content.show {
            display: block;
        }

        .info-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .recording-animation {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .recording-animation.active {
            display: flex;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger-color);
            animation: recording-pulse 1.5s ease-in-out infinite;
        }

        @keyframes recording-pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Transcribe Demo</h1>
            <p class="subtitle">Real-time audio transcription powered by Whisper and OpenAI</p>
        </header>

        <div class="main-content">
            <!-- Configuration Panel -->
            <div class="card">
                <h2>‚öôÔ∏è Configuration</h2>

                <div class="form-group">
                    <label for="backend">Backend</label>
                    <select id="backend">
                        <option value="whisper">Whisper (Local)</option>
                        <option value="realtime">Realtime (Cloud)</option>
                    </select>
                    <p class="info-text">Whisper runs locally, Realtime uses cloud API</p>
                </div>

                <div class="form-group">
                    <label for="model">Model</label>
                    <select id="model">
                        <option value="tiny.en">Tiny (fastest)</option>
                        <option value="base.en" selected>Base (balanced)</option>
                        <option value="small.en">Small</option>
                        <option value="medium.en">Medium</option>
                        <option value="large">Large (best quality)</option>
                        <option value="turbo">Turbo</option>
                    </select>
                    <p class="info-text">Larger models are more accurate but slower</p>
                </div>

                <div class="form-group">
                    <label for="language">Language</label>
                    <select id="language">
                        <option value="en" selected>English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="it">Italian</option>
                        <option value="pt">Portuguese</option>
                        <option value="zh">Chinese</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                    </select>
                </div>

                <div class="advanced-options">
                    <button class="advanced-toggle" id="advanced-toggle">
                        <span id="toggle-icon">‚ñ∂</span> Advanced Settings
                    </button>
                    <div class="advanced-content" id="advanced-content">
                        <div class="form-group">
                            <label for="vad-aggressiveness">VAD Aggressiveness (Whisper only)</label>
                            <select id="vad-aggressiveness">
                                <option value="0">0 (least aggressive)</option>
                                <option value="1">1</option>
                                <option value="2" selected>2 (default)</option>
                                <option value="3">3 (most aggressive)</option>
                            </select>
                            <p class="info-text">Higher values detect speech more strictly</p>
                        </div>

                        <div class="form-group">
                            <label for="min-silence">Min Silence Duration (seconds)</label>
                            <input type="number" id="min-silence" value="0.2" min="0.1" max="2.0" step="0.1">
                            <p class="info-text">Minimum silence before chunking</p>
                        </div>

                        <div class="form-group">
                            <label for="max-chunk">Max Chunk Duration (seconds)</label>
                            <input type="number" id="max-chunk" value="60" min="10" max="300" step="10">
                            <p class="info-text">Maximum duration for each audio chunk</p>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="partial-transcription">
                                Enable Partial Transcription (Whisper only)
                            </label>
                            <p class="info-text">Show real-time intermediate results</p>
                        </div>
                    </div>
                </div>

                <div class="control-buttons">
                    <button id="start-btn" class="btn-primary">
                        üé§ Start Recording
                    </button>
                    <button id="stop-btn" class="btn-danger" disabled>
                        ‚èπÔ∏è Stop
                    </button>
                </div>
            </div>

            <!-- Transcription Display -->
            <div class="card">
                <h2>üìù Transcript</h2>

                <div class="status">
                    <div class="status-indicator" id="status-indicator"></div>
                    <span id="status-text">Not connected</span>
                </div>

                <div class="recording-animation" id="recording-animation">
                    <div class="recording-dot"></div>
                    <span style="color: var(--danger-color); font-weight: 600;">Recording...</span>
                </div>

                <div class="transcript-container" id="transcript">
                    <div class="empty-state">
                        <div class="empty-state-icon">üéôÔ∏è</div>
                        <p>Click "Start Recording" to begin transcription</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();

        // UI elements
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const transcript = document.getElementById('transcript');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const recordingAnimation = document.getElementById('recording-animation');
        const advancedToggle = document.getElementById('advanced-toggle');
        const advancedContent = document.getElementById('advanced-content');
        const toggleIcon = document.getElementById('toggle-icon');

        // Audio recording
        let mediaRecorder = null;
        let audioContext = null;
        let mediaStream = null;
        let audioWorkletNode = null;
        let isRecording = false;

        // Advanced settings toggle
        advancedToggle.addEventListener('click', () => {
            advancedContent.classList.toggle('show');
            toggleIcon.textContent = advancedContent.classList.contains('show') ? '‚ñº' : '‚ñ∂';
        });

        // Socket.IO event handlers
        socket.on('connect', () => {
            updateStatus('connected', 'Connected to server');
        });

        socket.on('disconnect', () => {
            updateStatus('disconnected', 'Disconnected from server');
            stopRecording();
        });

        socket.on('transcription_started', () => {
            updateStatus('active', 'Transcription active');
        });

        socket.on('transcription_chunk', (data) => {
            addTranscriptChunk(data.text, data.is_final);
        });

        socket.on('transcription_complete', () => {
            updateStatus('connected', 'Transcription complete');
        });

        socket.on('transcription_stopped', () => {
            updateStatus('connected', 'Transcription stopped');
        });

        socket.on('transcription_error', (data) => {
            updateStatus('error', `Error: ${data.error}`);
            stopRecording();
        });

        // Start recording
        startBtn.addEventListener('click', async () => {
            try {
                // Get configuration
                const config = {
                    backend: document.getElementById('backend').value,
                    model: document.getElementById('model').value,
                    language: document.getElementById('language').value,
                    vad_aggressiveness: parseInt(document.getElementById('vad-aggressiveness').value),
                    min_silence_duration: parseFloat(document.getElementById('min-silence').value),
                    max_chunk_duration: parseFloat(document.getElementById('max-chunk').value),
                    partial_transcription: document.getElementById('partial-transcription').checked
                };

                // Start transcription session
                socket.emit('start_transcription', config);

                // Request microphone access
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true,
                    }
                });

                // Create audio context
                // Note: Browser may not honor the requested sample rate, so capture the actual rate
                audioContext = new AudioContext({ sampleRate: 16000 });
                const actualSampleRate = audioContext.sampleRate;

                // Log actual sample rate if different from requested
                if (actualSampleRate !== 16000) {
                    console.warn(`Browser using ${actualSampleRate}Hz instead of requested 16000Hz`);
                }

                // Load AudioWorklet module (modern replacement for deprecated ScriptProcessor)
                await audioContext.audioWorklet.addModule('/static/audio-processor.js');

                // Create AudioWorklet node
                audioWorkletNode = new AudioWorkletNode(audioContext, 'audio-capture-processor');

                // Handle audio data from the worklet
                audioWorkletNode.port.onmessage = (event) => {
                    if (!isRecording) return;

                    // Send to server as binary data (ArrayBuffer)
                    // The audio data is already in int16 format from the worklet
                    socket.emit('audio_chunk', {
                        audio: event.data.audio,
                        sample_rate: actualSampleRate
                    });
                };

                // Connect audio pipeline
                const source = audioContext.createMediaStreamSource(mediaStream);
                source.connect(audioWorkletNode);
                // Note: AudioWorklet doesn't need to connect to destination unless you want playback

                // Start recording in the worklet
                isRecording = true;
                audioWorkletNode.port.postMessage({ command: 'start' });

                startBtn.disabled = true;
                stopBtn.disabled = false;
                recordingAnimation.classList.add('active');

                // Clear previous transcript
                transcript.innerHTML = '';

            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Failed to access microphone: ' + error.message);
            }
        });

        // Stop recording
        stopBtn.addEventListener('click', () => {
            stopRecording();
        });

        function stopRecording() {
            // Stop recording in the worklet
            isRecording = false;
            if (audioWorkletNode) {
                audioWorkletNode.port.postMessage({ command: 'stop' });
                audioWorkletNode.disconnect();
                audioWorkletNode = null;
            }

            // Close audio context
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            // Stop all MediaStream tracks to release microphone
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            socket.emit('stop_transcription');

            startBtn.disabled = false;
            stopBtn.disabled = true;
            recordingAnimation.classList.remove('active');
        }

        function updateStatus(state, text) {
            statusIndicator.className = 'status-indicator';
            if (state === 'connected') {
                // No special class
            } else if (state === 'active') {
                statusIndicator.classList.add('active');
            } else if (state === 'error') {
                statusIndicator.classList.add('error');
            }
            statusText.textContent = text;
        }

        function addTranscriptChunk(text, isFinal) {
            // Remove empty state if present
            const emptyState = transcript.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const chunk = document.createElement('div');
            chunk.className = `transcript-chunk ${isFinal ? 'final' : 'partial'}`;
            chunk.textContent = text;

            // If this is a partial update, replace the last partial chunk
            if (!isFinal) {
                const lastPartial = transcript.querySelector('.transcript-chunk.partial:last-child');
                if (lastPartial) {
                    lastPartial.remove();
                }
            }

            transcript.appendChild(chunk);
            transcript.scrollTop = transcript.scrollHeight;
        }

        // Update model options based on backend selection
        document.getElementById('backend').addEventListener('change', (e) => {
            const modelSelect = document.getElementById('model');
            if (e.target.value === 'realtime') {
                // OpenAI Realtime API models
                modelSelect.innerHTML = `
                    <option value="gpt-realtime-mini" selected>GPT Realtime Mini (recommended)</option>
                    <option value="gpt-4o-realtime-preview">GPT-4o Realtime Preview</option>
                `;
            } else {
                // Whisper models
                modelSelect.innerHTML = `
                    <option value="tiny.en">Tiny (fastest)</option>
                    <option value="base.en" selected>Base (balanced)</option>
                    <option value="small.en">Small</option>
                    <option value="medium.en">Medium</option>
                    <option value="large">Large (best quality)</option>
                    <option value="turbo">Turbo</option>
                `;
            }
        });
    </script>
</body>
</html>
