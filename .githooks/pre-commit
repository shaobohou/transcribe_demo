#!/bin/sh
set -eu

if ! command -v uv >/dev/null 2>&1; then
    echo "pre-commit hook: uv not found; install uv to run tests." >&2
    exit 1
fi

if [ -z "${UV_CACHE_DIR:-}" ]; then
    repo_cache="$(pwd)/.uv-cache"
    mkdir -p "$repo_cache"
    export UV_CACHE_DIR="$repo_cache"
fi

echo "--- DEBUGGING PRE-COMMIT HOOK ---"
echo "Running git diff --cached --name-only --diff-filter=ACM -- '*.py'"
staged_python_files=$(git diff --cached --name-only -- '*.py')
echo "staged_python_files: $staged_python_files"
echo "--- END DEBUGGING ---"

if [ -n "$staged_python_files" ]; then
    echo "pre-commit hook: formatting staged Python files with ruff"
    uv run ruff format $staged_python_files

    echo "pre-commit hook: linting staged Python files with ruff (auto-fix enabled)"
    uv run ruff check $staged_python_files --fix

    git add $staged_python_files

    echo "pre-commit hook: verifying staged Python files after fixes"
    uv run ruff format --check $staged_python_files
    uv run ruff check $staged_python_files

    echo "pre-commit hook: running pyright"
    uv run pyright
else
    echo "pre-commit hook: no staged Python files detected; skipping ruff steps"
fi

echo "pre-commit hook: running uv run python -m pytest"
uv run python -m pytest
